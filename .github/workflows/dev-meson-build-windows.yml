name: Meson MSVC Build

on:
  push:
    branches:
      - dev

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.14"
      - name: Setup MSVC environment
        shell: pwsh
        run: |
            # Find vcvarsall.bat
            $vcvarsallPath = (vswhere -latest -products Microsoft.VisualStudio.Product.BuildTools -property installationPath) + "\VC\Auxiliary\Build\vcvarsall.bat"
            
            # Invoke vcvarsall and capture environment
            $envChanges = & "$vcvarsallPath" x64 -vcvars_dump
            
            # Export changes to GITHUB_ENV
            foreach ($line in $envChanges) {
                if ($line -match '^SET\s+(\w+)=(.+)$') {
                    "$(($matches[1]))=$(($matches[2]))" | Out-File -FilePath $env:GITHUB_ENV -Append
                }
            }

      - name: Configure and Build with Meson
        run: |
            python -m pip install meson
            meson setup builddir
            meson compile -C builddir